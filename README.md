# FreqInTime (FIT)
绘制 **基频** 关于 **时间** 的变化曲线：从麦克风计算基频，绘制到画布上

[→在线Demo←](https://madderscientist.github.io/FreqInTime/)

*感觉可以做成Flappy Bird这样的游戏，频率决定高度*

## 使用
点击屏幕授权麦克风权限，然后开始演奏！可以用鼠标、手指上下拖拽屏幕，以查看视野外的音高。

## 设计思路
一个心血来潮的小小小工具。高中时用Appinventor写过一个类似的[哼歌扒谱apk](https://www.bilibili.com/video/BV18E411A7kC/)，前几日教社团成员口琴压音，就用到了这个软件，初衷和效果是很好的，但感到有如下问题：
1. 突变很多，绘图不好看；频率上低下高，和平时习惯不符。
2. 线性尺度的频率纵轴浪费空间（当时为了解决这个问题设置了两个区间，一个显示高音，一个显示低音，却导致了操作复杂，因为要切换）
3. 操作繁琐。一个是上一点提到的问题；另一个是即使没有频率时间轴也在走，当时想着要如实反应频率和时间的关系所以这样设计，但是导致画布经常画满，经常要手动清除。于是使用了宽度超过屏幕大小的画布（增加时间轴），但是这样要手动移动画布，而且治标不治本，画满了就要手动清除。

总之，只是能用，但不好用（其实是Appinventor编写复杂逻辑不方便，当年偷懒了）。四年半后的今天我已经大学快毕业了，早就无需依赖图形化编程，于是想重新实现一下。

### 针对问题1
设计了尖峰处理，并且翻转了y轴。<br>
**尖峰消除**的基本思路是，遇到突变，如果后面N个数据与其相近，则承认此突变；否则忽略。有两个阈值：突变检测阈值，和相近判断阈值，前者应该比后者范围大。由于音符频率是对数尺度，故阈值用倍数表示，用乘除定义区间。详见文件[noPeak.js](./noPeak.js)

### 针对问题2
使用对数频率坐标，一次性显示C1~B7，画布可上下拖拽。

### 针对问题3
当年因为Appinventor不方便写复杂逻辑，所以没有保存历史，每次直接在后面接着画，所以会画到屏幕外，所以要定时手动清除画布才能回到原点。这次我保存了历史频率，丢弃过早的历史，每次重新绘制，便可模拟时间轴自动左移，无需手动清除。<br>
此外，我设计能量超过阈值才计算频率，有频率才绘制；窗口只能上下滑动（频率轴），且视野可以自动跟随，无需手动移动视野。

## 文件结构
```
audioInput.js   是 Web Audio API 获取麦克风的封装，用于得到时域数据
F0.js           计算基频的方法 内含一个自相关函数
freqCanvas.js   基于画布的可视化封装类
freqTable.js    处理十二平均律
index.html      主程序
noPeak.js       消除尖峰
README.md       本文件
style.css       样式
```